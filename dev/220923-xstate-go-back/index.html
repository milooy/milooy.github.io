<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 4.25.7"/><meta data-react-helmet="true" name="description" content="유한 상태머신에 동적인 이벤트 끼얹기"/><meta data-react-helmet="true" property="og:title" content="XState에서 뒤로가기 구현"/><meta data-react-helmet="true" property="og:description" content="유한 상태머신에 동적인 이벤트 끼얹기"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="jayjinjay"/><meta data-react-helmet="true" name="twitter:title" content="XState에서 뒤로가기 구현"/><meta data-react-helmet="true" name="twitter:description" content="유한 상태머신에 동적인 이벤트 끼얹기"/><style data-href="/styles.8f3185d92afe4178fb76.css" data-identity="gatsby-global-css">@import url(https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200;400;700;900&display=swap);@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100-8d7d79679b70dbe27172b6460e7a7910.woff2) format("woff2"),url(/static/montserrat-latin-100-ec38980a9e0119a379e2a9b3dbb1901a.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic-e279051046ba1286706adc886cf1c96b.woff2) format("woff2"),url(/static/montserrat-latin-100italic-3b325a3173c8207435cd1b76e19bf501.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200-9d266fbbfa6cab7009bd56003b1eeb67.woff2) format("woff2"),url(/static/montserrat-latin-200-2d8ba08717110d27122e54c34b8a5798.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic-6e5b3756583bb2263eb062eae992735e.woff2) format("woff2"),url(/static/montserrat-latin-200italic-a0d6f343e4b536c582926255367a57da.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300-00b3e893aab5a8fd632d6342eb72551a.woff2) format("woff2"),url(/static/montserrat-latin-300-ea303695ceab35f17e7d062f30e0173b.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic-56f34ea368f6aedf89583d444bbcb227.woff2) format("woff2"),url(/static/montserrat-latin-300italic-54b0bf2c8c4c12ffafd803be2466a790.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400-b71748ae4f80ec8c014def4c5fa8688b.woff2) format("woff2"),url(/static/montserrat-latin-400-0659a9f4e90db5cf51b50d005bff1e41.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic-6eed6b4cbb809c6efc7aa7ddad6dbe3e.woff2) format("woff2"),url(/static/montserrat-latin-400italic-7583622cfde30ae49086d18447ab28e7.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500-091b209546e16313fd4f4fc36090c757.woff2) format("woff2"),url(/static/montserrat-latin-500-edd311588712a96bbf435fad264fff62.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic-c90ced68b46050061d1a41842d6dfb43.woff2) format("woff2"),url(/static/montserrat-latin-500italic-5146cbfe02b1deea5dffea27a5f2f998.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600-0480d2f8a71f38db8633b84d8722e0c2.woff2) format("woff2"),url(/static/montserrat-latin-600-b77863a375260a05dd13f86a1cee598f.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic-cf46ffb11f3a60d7df0567f8851a1d00.woff2) format("woff2"),url(/static/montserrat-latin-600italic-c4fcfeeb057724724097167e57bd7801.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700-7dbcc8a5ea2289d83f657c25b4be6193.woff2) format("woff2"),url(/static/montserrat-latin-700-99271a835e1cae8c76ef8bba99a8cc4e.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic-c41ad6bdb4bd504a843d546d0a47958d.woff2) format("woff2"),url(/static/montserrat-latin-700italic-6779372f04095051c62ed36bc1dcc142.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800-db9a3e0ba7eaea32e5f55328ace6cf23.woff2) format("woff2"),url(/static/montserrat-latin-800-4e3c615967a2360f5db87d2f0fd2456f.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic-bf45bfa14805969eda318973947bc42b.woff2) format("woff2"),url(/static/montserrat-latin-800italic-fe82abb0bcede51bf724254878e0c374.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900-e66c7edc609e24bacbb705175669d814.woff2) format("woff2"),url(/static/montserrat-latin-900-8211f418baeb8ec880b80ba3c682f957.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic-4454c775e48152c1a72510ceed3603e2.woff2) format("woff2"),url(/static/montserrat-latin-900italic-efcaa0f6a82ee0640b83a0916e6e8d68.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300-fc117160c69a8ea0851b26dd14748ee4.woff2) format("woff2"),url(/static/merriweather-latin-300-58b18067ebbd21fda77b67e73c241d3b.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic-fe29961474f8dbf77c0aa7b9a629e4bc.woff2) format("woff2"),url(/static/merriweather-latin-300italic-23c3f1f88683618a4fb8d265d33d383a.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400-d9479e8023bef9cbd9bf8d6eabd6bf36.woff2) format("woff2"),url(/static/merriweather-latin-400-040426f99ff6e00b86506452e0d1f10b.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic-2de7bfeaf08fb03d4315d49947f062f7.woff2) format("woff2"),url(/static/merriweather-latin-400italic-79db67aca65f5285964ab332bd65f451.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700-4b08e01d805fa35d7bf777f1b24314ae.woff2) format("woff2"),url(/static/merriweather-latin-700-22fb8afba4ab1f093b6ef9e28a9b6e92.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic-cd92541b177652fffb6e3b952f1c33f1.woff2) format("woff2"),url(/static/merriweather-latin-700italic-f87f3d87cea0dd0979bfc8ac9ea90243.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900-f813fc6a4bee46eda5224ac7ebf1b7be.woff2) format("woff2"),url(/static/merriweather-latin-900-5d4e42cb44410674acd99153d57df032.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic-b7901d85486871c1779c0e93ddd85656.woff2) format("woff2"),url(/static/merriweather-latin-900italic-9647f9fdab98756989a8a5550eb205c3.woff) format("woff")}


/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden]{display:none}:root{--maxWidth-none:"none";--maxWidth-xs:20rem;--maxWidth-sm:24rem;--maxWidth-md:28rem;--maxWidth-lg:32rem;--maxWidth-xl:36rem;--maxWidth-2xl:42rem;--maxWidth-3xl:48rem;--maxWidth-4xl:56rem;--maxWidth-full:"100%";--maxWidth-wrapper:var(--maxWidth-2xl);--spacing-px:"1px";--spacing-0:0;--spacing-1:0.35rem;--spacing-2:0.5rem;--spacing-3:0.75rem;--spacing-4:1rem;--spacing-5:1.25rem;--spacing-6:1.5rem;--spacing-8:2rem;--spacing-10:2.5rem;--spacing-12:3rem;--spacing-16:4rem;--spacing-20:5rem;--spacing-24:6rem;--spacing-32:8rem;--fontFamily-sans:"Noto Serif KR",serif;--fontFamily-serif:"Noto Serif KR",serif;--font-body:var(--fontFamily-serif);--font-heading:var(--fontFamily-sans);--fontWeight-normal:400;--fontWeight-medium:500;--fontWeight-semibold:600;--fontWeight-bold:700;--fontWeight-extrabold:800;--fontWeight-black:900;--fontSize-root:16px;--lineHeight-none:1;--lineHeight-tight:1.1;--lineHeight-normal:1.5;--lineHeight-relaxed:1.625;--fontSize-0:0.833rem;--fontSize-1:1.1rem;--fontSize-2:1.2rem;--fontSize-3:1.44rem;--fontSize-4:1.728rem;--fontSize-5:2.074rem;--fontSize-6:2.488rem;--fontSize-7:2.986rem;--color-primary:#fe9f2d;--color-primary-2:#4bacce;--color-text:#52575a;--color-text-light:#4f5969;--color-heading:#1a202c;--color-heading-black:#000;--color-accent:#e0ddaa;--color-highlight-1:#5a616b;--color-highlight-2:#8e9a9c;--color-gray-900:#16161c;--color-blueGray-500:#cfd4e9;--color-background:#f7f8f9;--color-background-2:#fcfdfc;--color-background-3:#fdfcfc;--color-border:#e5e8ea}*,:after,:before{word-wrap:break-word;box-sizing:border-box}html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-size:var(--fontSize-root);line-height:var(--lineHeight-normal)}body{background:var(--color-background-2);color:var(--color-text);font-family:var(--font-body);font-size:var(--fontSize-1)}footer{padding:var(--spacing-6) var(--spacing-0)}hr{background:var(--color-accent);border:0;height:1px}h1,h2,h3,h4,h5,h6{font-family:var(--font-heading);letter-spacing:-.025em;margin-bottom:var(--spacing-6);margin-top:var(--spacing-12)}h2,h3,h4,h5,h6{font-weight:var(--fontWeight-bold)}h1{font-size:var(--fontSize-6);font-weight:var(--fontWeight-black)}h2{color:var(--color-primary-2);font-size:var(--fontSize-5);margin-bottom:var(--spacing-4);margin-top:var(--spacing-24)}h3{font-size:var(--fontSize-4)}h4{font-size:var(--fontSize-3)}h5{font-size:var(--fontSize-2)}h6{font-size:var(--fontSize-1)}h1>a,h2>a,h3>a,h4>a,h5>a,h6>a{color:inherit;text-decoration:none}p{--baseline-multiplier:0.179;--x-height-multiplier:0.35;line-height:var(--lineHeight-relaxed);margin:var(--spacing-0) var(--spacing-0) var(--spacing-8) var(--spacing-0)}ol,p,ul{padding:var(--spacing-0)}ol,ul{list-style-image:none;list-style-position:outside;margin-bottom:var(--spacing-8);margin-left:var(--spacing-0);margin-right:var(--spacing-0)}ol li,ul li{padding-left:var(--spacing-0)}li>p,ol li,ul li{margin-bottom:calc(var(--spacing-8)/2)}li :last-child{margin-bottom:var(--spacing-0)}li>ul{margin-left:var(--spacing-8);margin-top:calc(var(--spacing-8)/2)}blockquote{border-left:var(--spacing-1) solid var(--color-accent);font-size:var(--fontSize-1);font-style:italic;margin-bottom:var(--spacing-8);margin-left:calc(var(--spacing-6)*-1);margin-right:var(--spacing-8);padding:var(--spacing-0) var(--spacing-0) var(--spacing-0) var(--spacing-6)}blockquote>:last-child{margin-bottom:var(--spacing-0)}blockquote>ol,blockquote>ul{list-style-position:inside}table{border-collapse:collapse;border-spacing:.25rem;margin-bottom:var(--spacing-8);width:100%}table thead tr th{border-bottom:1px solid var(--color-accent)}a{color:var(--color-primary)}a:focus,a:hover{text-decoration:none}.global-wrapper{margin:var(--spacing-0) auto;max-width:var(--maxWidth-wrapper);padding:var(--spacing-10) var(--spacing-5)}.global-wrapper[data-is-root-path=true] .bio{margin-bottom:var(--spacing-20)}.global-header{margin-bottom:var(--spacing-12)}.main-heading{margin:0}.post-list-item{margin-bottom:var(--spacing-8);margin-top:var(--spacing-8)}.post-list-item p{margin-bottom:var(--spacing-0)}.post-list-item h2{color:var(--color-text);font-size:var(--fontSize-4);font-weight:900;margin-bottom:var(--spacing-2);margin-top:var(--spacing-0)}.post-list-item header{margin-bottom:var(--spacing-4)}.header-link-home{font-family:var(--font-heading);font-size:var(--fontSize-2);font-weight:var(--fontWeight-bold);text-decoration:none}.bio{display:flex;margin-bottom:var(--spacing-16)}.bio p,.bio-avatar{margin-bottom:var(--spacing-0)}.bio-avatar{border-radius:100%;margin-right:var(--spacing-4);min-width:50px}.blog-post header h1{font-family:var(--fontFamily-serif);font-size:var(--fontSize-7);font-weight:var(--fontWeight-extrabold);margin:var(--spacing-0) var(--spacing-0) var(--spacing-4) var(--spacing-0)}.blog-post header p{color:var(--color-text-light);font-size:var(--fontSize-1)}.blog-post-nav ul{margin:var(--spacing-0)}.gatsby-highlight{margin-bottom:var(--spacing-8)}.gatsby-highlight pre{background:var(--color-background)!important;border:1px solid var(--color-border)}@media (max-width:42rem){blockquote{margin-left:var(--spacing-0);padding:var(--spacing-0) var(--spacing-0) var(--spacing-0) var(--spacing-4)}ol,ul{list-style-position:inside}}img{width:100%}code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#000;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;text-shadow:0 1px #fff;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#b3d4fc;text-shadow:none}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:hsla(0,0%,100%,.5);color:#9a6e3a}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><link rel="alternate" type="application/rss+xml" title="Gatsby Starter Blog RSS Feed" href="/rss.xml"/><link rel="icon" href="/favicon-32x32.png?v=4a9773549091c227cd2eb82ccd9c5e3a" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><title data-react-helmet="true">XState에서 뒤로가기 구현 | 유림로그</title><style data-styled="" data-styled-version="5.3.11">.iGixYo{background:var(--color-background);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;list-style:none;border-bottom:1px solid var(--color-border);padding-left:24px;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-bottom:0;margin-top:0;padding-top:16px;}/*!sc*/
data-styled.g1[id="TopNav__Categories-sc-daeuvx-0"]{content:"iGixYo,"}/*!sc*/
.faScpJ{margin-right:3rem;-webkit-text-decoration:none;text-decoration:none;color:black;}/*!sc*/
data-styled.g3[id="TopNav__StyledLink-sc-daeuvx-2"]{content:"faScpJ,"}/*!sc*/
.lhQDnD{margin-bottom:70px;}/*!sc*/
data-styled.g4[id="blog-post__Header-sc-a8k2ed-0"]{content:"lhQDnD,"}/*!sc*/
.gmuhrq{font-weight:bold;margin-bottom:0;font-family:"Segoe UI";}/*!sc*/
data-styled.g5[id="blog-post__Category-sc-a8k2ed-1"]{content:"gmuhrq,"}/*!sc*/
.dowLmw{text-align:right;}/*!sc*/
data-styled.g6[id="blog-post__Date-sc-a8k2ed-2"]{content:"dowLmw,"}/*!sc*/
</style></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><nav style="display:flex;justify-content:space-between;border-bottom:1px solid var(--color-border);background:var(--color-background-3);align-items:center;padding-left:24px"><a style="text-decoration:none" href="/"><h1 style="margin:0">Today yurim felt</h1></a><div data-gatsby-image-wrapper="" class="gatsby-image-wrapper gatsby-image-wrapper-constrained main-heading"><div style="max-width:91px;display:block"><img alt="" role="presentation" aria-hidden="true" src="data:image/svg+xml;charset=utf-8,%3Csvg height=&#x27;110&#x27; width=&#x27;91&#x27; xmlns=&#x27;http://www.w3.org/2000/svg&#x27; version=&#x27;1.1&#x27;%3E%3C/svg%3E" style="max-width:100%;display:block;position:static"/></div><div aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear"></div><picture><source type="image/avif" data-srcset="/static/6f6993e6bccd3c63f94928a53c7d7f94/a0d16/profile-pic.avif 23w,/static/6f6993e6bccd3c63f94928a53c7d7f94/440f0/profile-pic.avif 46w,/static/6f6993e6bccd3c63f94928a53c7d7f94/aec04/profile-pic.avif 91w,/static/6f6993e6bccd3c63f94928a53c7d7f94/d0ad7/profile-pic.avif 182w" sizes="(min-width: 91px) 91px, 100vw"/><source type="image/webp" data-srcset="/static/6f6993e6bccd3c63f94928a53c7d7f94/28220/profile-pic.webp 23w,/static/6f6993e6bccd3c63f94928a53c7d7f94/eb98e/profile-pic.webp 46w,/static/6f6993e6bccd3c63f94928a53c7d7f94/17797/profile-pic.webp 91w,/static/6f6993e6bccd3c63f94928a53c7d7f94/d6581/profile-pic.webp 182w" sizes="(min-width: 91px) 91px, 100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="(min-width: 91px) 91px, 100vw" decoding="async" loading="lazy" data-src="/static/6f6993e6bccd3c63f94928a53c7d7f94/36cff/profile-pic.png" data-srcset="/static/6f6993e6bccd3c63f94928a53c7d7f94/06956/profile-pic.png 23w,/static/6f6993e6bccd3c63f94928a53c7d7f94/39458/profile-pic.png 46w,/static/6f6993e6bccd3c63f94928a53c7d7f94/36cff/profile-pic.png 91w,/static/6f6993e6bccd3c63f94928a53c7d7f94/421e0/profile-pic.png 182w" alt="Profile picture"/></picture><noscript><picture><source type="image/avif" srcSet="/static/6f6993e6bccd3c63f94928a53c7d7f94/a0d16/profile-pic.avif 23w,/static/6f6993e6bccd3c63f94928a53c7d7f94/440f0/profile-pic.avif 46w,/static/6f6993e6bccd3c63f94928a53c7d7f94/aec04/profile-pic.avif 91w,/static/6f6993e6bccd3c63f94928a53c7d7f94/d0ad7/profile-pic.avif 182w" sizes="(min-width: 91px) 91px, 100vw"/><source type="image/webp" srcSet="/static/6f6993e6bccd3c63f94928a53c7d7f94/28220/profile-pic.webp 23w,/static/6f6993e6bccd3c63f94928a53c7d7f94/eb98e/profile-pic.webp 46w,/static/6f6993e6bccd3c63f94928a53c7d7f94/17797/profile-pic.webp 91w,/static/6f6993e6bccd3c63f94928a53c7d7f94/d6581/profile-pic.webp 182w" sizes="(min-width: 91px) 91px, 100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="(min-width: 91px) 91px, 100vw" decoding="async" loading="lazy" src="/static/6f6993e6bccd3c63f94928a53c7d7f94/36cff/profile-pic.png" srcSet="/static/6f6993e6bccd3c63f94928a53c7d7f94/06956/profile-pic.png 23w,/static/6f6993e6bccd3c63f94928a53c7d7f94/39458/profile-pic.png 46w,/static/6f6993e6bccd3c63f94928a53c7d7f94/36cff/profile-pic.png 91w,/static/6f6993e6bccd3c63f94928a53c7d7f94/421e0/profile-pic.png 182w" alt="Profile picture"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1,e.parentNode.parentNode.querySelector("[data-placeholder-image]").style.opacity=0)}}</script></div></nav><ul class="TopNav__Categories-sc-daeuvx-0 iGixYo"><a class="TopNav__StyledLink-sc-daeuvx-2 faScpJ" href="/intro"><li class="TopNav__CategoryItem-sc-daeuvx-1 cYBFQR">나는</li></a><a class="TopNav__StyledLink-sc-daeuvx-2 faScpJ" href="/category/dev"><li class="TopNav__CategoryItem-sc-daeuvx-1 cYBFQR">개발 이야기</li></a><a class="TopNav__StyledLink-sc-daeuvx-2 faScpJ" href="/category/life"><li class="TopNav__CategoryItem-sc-daeuvx-1 cYBFQR">사는 이야기</li></a><a class="TopNav__StyledLink-sc-daeuvx-2 faScpJ" href="/category/book"><li class="TopNav__CategoryItem-sc-daeuvx-1 cYBFQR">책 읽어요</li></a><a class="TopNav__StyledLink-sc-daeuvx-2 faScpJ" href="/category/art"><li class="TopNav__CategoryItem-sc-daeuvx-1 cYBFQR">그림 그리기</li></a><a class="TopNav__StyledLink-sc-daeuvx-2 faScpJ" href="/category/media"><li class="TopNav__CategoryItem-sc-daeuvx-1 cYBFQR">눈과 귀</li></a><a class="TopNav__StyledLink-sc-daeuvx-2 faScpJ" href="/inbox"><li class="TopNav__CategoryItem-sc-daeuvx-1 cYBFQR">글감상자</li></a><a class="TopNav__StyledLink-sc-daeuvx-2 faScpJ" href="/guest"><li class="TopNav__CategoryItem-sc-daeuvx-1 cYBFQR">방명록</li></a></ul><div class="global-wrapper" data-is-root-path="false"><main><article class="blog-post" itemscope="" itemType="http://schema.org/Article"><header class="blog-post__Header-sc-a8k2ed-0 lhQDnD"><p class="blog-post__Category-sc-a8k2ed-1 gmuhrq">DEV</p><h1 itemProp="headline">XState에서 뒤로가기 구현</h1><p class="blog-post__Date-sc-a8k2ed-2 dowLmw">September 23, 2022</p></header><section itemProp="articleBody"><p>XState를 들어보셨나요?
복잡한 이벤트, 상태를 선언적으로 개발할 수 있는 FSM이란 모델을
자바스크립트에서 쉽게 쓸 수 있게 구현해둔 라이브러리입니다.
(XState가 더 궁금하다면? → <a href="https://milooy.github.io/dev/220913-xstate/">https://milooy.github.io/dev/220913-xstate/</a>)</p>
<p>저는 핸드폰 요금제 가입 Flow를 개발할 때 XState를 사용했는데요,
여러 페이지에 거쳐 유저가 기입한 정보를 얻어내는 flow를 한번에 정의하기 참 좋아서 만족도가 높았습니다</p>
<p>예를 들면</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">[통신사 선택 페이지] ->(다음 버튼 클릭) -> [납부카드 입력 페이지]
                                 -> (직접기입 버튼 클릭) -> [직접입력 페이지]</code></pre></div>
<p>디자이너가 한 판으로 그려주는 이런 일련의 flow를 다음과 같이 객체 하나로 정의할 수 있게 되는거죠.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token punctuation">{</span>
  <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">통신사선택페이지</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">다음버튼클릭</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'납부카드입력페이지'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">직접기입버튼클릭</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'통신사직접입력페이지'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">통신사직접입력페이지</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">직접기입버튼클릭</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'납부카드입력페이지'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">납부카드입력페이지</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'final'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>다만 큰 산이 하나 있었습니다.
여러 페이지에 거쳐 정보를 받아내는 설문조사형 UX라 뒤로가기, 앞으로가기가 가능해야하는데
“가용한 모든 이벤트와 상태를 정적으로 미리 생성해둔다!” 란 XState의 컨셉에선
“동적으로 쌓이는 history를 참조해서 페이지를 이동시킨다!” 가 근본적으로 들어맞지 않더라구요.</p>
<p>조금 더 상세히 보면,
XState는 정해진 개수의 이벤트를 통해 상태를 변경시키는 컨셉을 가지고 있습니다.
예를 들어 NEXT라는 이벤트를 통해 A페이지에서 B페이지로 상태를 이동했다면,
뒤로가기를 위해서 B페이지에서 A페이지로 상태를 이동하는 이벤트도 사전에 정의해줘야 합니다.</p>
<p>하지만 이를 위해 모든 노드에 뒤로가기 이벤트를 하드코딩으로 심는건 비효율적일 뿐더러
동적으로 이동한 경우나 앞으로가는 경우는 실제 브라우저의 history가 쌓이기 전까진 알 수 없습니다
(e.g. C에서 뒤로가기시 A에서 왔는지, B에서 왔는지 정적으로는 판별 불가능)</p>
<p>하지만 결국 그랬듯이 우리는 답을 찾아낼 수 있습니다.</p>
<h2>방법1: 정적인 배열을 참고해 뒤로갈, 앞으로 갈 페이지 알아내기</h2>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> steps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"a페이지"</span><span class="token punctuation">,</span> <span class="token string">"b페이지"</span><span class="token punctuation">,</span> <span class="token string">"c페이지"</span><span class="token punctuation">]</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> machine <span class="token operator">=</span> <span class="token function">createMachine</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token constant">BACK</span><span class="token operator">:</span> steps<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">currentStep</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> previousStep <span class="token operator">=</span> steps<span class="token punctuation">[</span>steps<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>currentStep<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">cond</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">_context<span class="token punctuation">,</span> _event<span class="token punctuation">,</span> meta</span><span class="token punctuation">)</span> <span class="token operator">=></span> meta<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>currentStep<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">target</span><span class="token operator">:</span> previousStep<span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>페이지를 이동하는 순서가 정해져있다면 쉽게 앞으로가기, 뒤로가기 이벤트를 정적으로 생성해낼 수 있습니다.</p>
<p>다만 뒤로가기 해서 보여줘야 하는 페이지가 런타임에 동적으로 정해진다면 사용할 수 없습니다.</p>
<p>(C페이지가 A에서 왔는지, B에서 왔는지는 사용자가 어떻게 쓰냐에 따라 달라지니)</p>
<ul>
<li>비슷한 디스커션: <a href="https://github.com/statelyai/xstate/discussions/1939">https://github.com/statelyai/xstate/discussions/1939</a></li>
</ul>
<h2>방법2: 상태 그래프를 통해 정적으로 역계산 + Context에서 History객체 관리</h2>
<h3>예시 상황</h3>
<blockquote>
<p>A페이지에서 이벤트1을 하면 B페이지로 가고, 이벤트2를 하면 C페이지로 갑니다.
B페이지에서 이벤트3을 하면 C페이지로 갑니다.</p>
</blockquote>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token punctuation">{</span>
  <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token constant">A</span><span class="token literal-property property">페이지</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        이벤트<span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'B페이지'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        이벤트<span class="token number">2</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'C페이지'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token constant">B</span><span class="token literal-property property">페이지</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        이벤트<span class="token number">3</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'C페이지'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token constant">C</span><span class="token literal-property property">페이지</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'final'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>여기서 C페이지에서 뒤로가기 하면 히스토리에 따라 B페이지/A페이지로 갈 수 있습니다.
이를 미리 정의해놓기 위해 state를 참고해 target을 C페이지로 보내는 모든 노드를 찾고(A페이지, B페이지)</p>
<ul>
<li>cond에서 context를 참고해 이전 페이지로 돌아갈 수 있는 조건을 만들어줍니다.
<ul>
<li>컨디션1: context.previousStep이 A페이지면 A페이지로 보낸다</li>
<li>컨디션2: context.previousStep이 B페이지면 B페이지로 보낸다</li>
</ul>
</li>
</ul>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token punctuation">{</span>
  <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token constant">BACK</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token function-variable function">cond</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> _event<span class="token punctuation">,</span> meta</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> currentStepName <span class="token operator">=</span> <span class="token string">"C페이지"</span>
          <span class="token keyword">const</span> previousStepName <span class="token operator">=</span>
            context<span class="token punctuation">.</span>history<span class="token punctuation">[</span>context<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>currentStep<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
          <span class="token keyword">return</span> <span class="token punctuation">(</span>
            meta<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>currentStepName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            previousStepName <span class="token operator">===</span> <span class="token string">"A페이지"</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">"A페이지"</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token function-variable function">cond</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> _event<span class="token punctuation">,</span> meta</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> currentStepName <span class="token operator">=</span> <span class="token string">"C페이지"</span>
          <span class="token keyword">const</span> previousStepName <span class="token operator">=</span>
            context<span class="token punctuation">.</span>history<span class="token punctuation">[</span>context<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>currentStep<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
          <span class="token keyword">return</span> <span class="token punctuation">(</span>
            meta<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>currentStepName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            previousStepName <span class="token operator">===</span> <span class="token string">"B페이지"</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">"B페이지"</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h3>코드</h3>
<p>이는 코드로 다음과 같이 표현할 수 있습니다.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">generateBackConditionsWithContext</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">states</span><span class="token operator">:</span> StatesConfig<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token punctuation">,</span> any<span class="token operator">></span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token literal-property property">backConditions</span><span class="token operator">:</span> TransitionsConfig<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>states<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> stateNodeConfig <span class="token operator">=</span> states<span class="token punctuation">[</span>state<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stateNodeConfig <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> targetStepNodes <span class="token operator">=</span> <span class="token function">deepSearchItems</span><span class="token punctuation">(</span>stateNodeConfig<span class="token punctuation">,</span> <span class="token string">"target"</span><span class="token punctuation">)</span>

    targetStepNodes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> target <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      backConditions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token function-variable function">cond</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> _event<span class="token punctuation">,</span> meta</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> currentStepName <span class="token operator">=</span> target
          <span class="token comment">// TODO: 뭔가 히스토리가 이상한데? indexOf인지 lastIndexOf인지 확인필요</span>
          <span class="token keyword">const</span> previousStepName <span class="token operator">=</span>
            context<span class="token punctuation">.</span>history<span class="token punctuation">[</span>context<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span>currentStepName<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
          <span class="token keyword">return</span> <span class="token punctuation">(</span>
            meta<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>currentStepName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> previousStepName <span class="token operator">===</span> state
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">target</span><span class="token operator">:</span> state<span class="token punctuation">,</span>
        <span class="token literal-property property">event</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token comment">// 필요 없지만 타입을 맞추기 위해 넣음</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> backConditions
<span class="token punctuation">}</span>

<span class="token comment">// @see https://stackoverflow.com/a/54470906</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">deepSearchItems</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">object</span><span class="token operator">:</span> Record<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">></span><span class="token punctuation">,</span> <span class="token literal-property property">keyToFind</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token literal-property property">result</span><span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> hasKeyProperty <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> keyToFind<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>hasKeyProperty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>result<span class="token punctuation">,</span> object<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> objectKey <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>objectKey <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> object<span class="token punctuation">[</span>objectKey<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">"object"</span> <span class="token operator">&amp;&amp;</span> value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> o <span class="token operator">=</span> <span class="token function">deepSearchItems</span><span class="token punctuation">(</span>object<span class="token punctuation">[</span>objectKey<span class="token punctuation">]</span><span class="token punctuation">,</span> keyToFind<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> o <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>result<span class="token punctuation">,</span> <span class="token operator">...</span>o<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span></code></pre></div>
<p>머신을 사용하는 측에서 히스토리 관련 코드를 추가합니다.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 1. 상태 전이가 일어날 때마다 URL을 shallow업데이트 해서 history를 관리하고, xstate context에 history를 추가적으로 쌓는 액션을 호출합니다.</span>
<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  service<span class="token punctuation">.</span><span class="token function">onTransition</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> isTransitionBySendingPushHistoryEvent <span class="token operator">=</span>
      state<span class="token punctuation">.</span>event<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"PUSH_HISTORY"</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isTransitionBySendingPushHistoryEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">QS</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>Router<span class="token punctuation">.</span>query<span class="token punctuation">,</span> <span class="token punctuation">[</span>stepQueryKey<span class="token punctuation">]</span><span class="token operator">:</span> state<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    Router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">shallow</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"PUSH_HISTORY"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">currentStep</span><span class="token operator">:</span> state<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>send<span class="token punctuation">,</span> service<span class="token punctuation">,</span> stepQueryKey<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// 2. 뒤로가기시에 xstate 상태도 동기화를 시켜주기 위해 xstate액션을 호출합니다</span>
<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  Router<span class="token punctuation">.</span><span class="token function">beforePopState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> <span class="token keyword">as</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">as</span> <span class="token operator">!==</span> Router<span class="token punctuation">.</span>asPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// TODO: 앞으로 가기 대응필요</span>
      <span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"BACK"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    Router<span class="token punctuation">.</span><span class="token function">beforePopState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>send<span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div>
<p>xstate 머신에도 PUSH_HISTORY, BACK 이벤트를 추가해주면 완성!</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> machine <span class="token operator">=</span> createMachine<span class="token operator">&lt;</span>FunnelContext<span class="token punctuation">,</span> AnyEventObject<span class="token punctuation">,</span> FunnelTypeState<span class="token operator">></span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">predictableActionArguments</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">'뒤로가기가능머신'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token constant">PUSH_HISTORY</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">actions</span><span class="token operator">:</span> <span class="token string">'pushHistory'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token constant">BACK</span><span class="token operator">:</span> <span class="token function">generateBackConditionsWithContext</span><span class="token punctuation">(</span>states<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    states<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token punctuation">{</span>
    <span class="token literal-property property">actions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">pushHistory</span><span class="token operator">:</span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token function-variable function">history</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token operator">...</span>prev<span class="token punctuation">.</span>history<span class="token punctuation">,</span> event<span class="token punctuation">.</span>currentStep<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">guards</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h2>방법3: 인접노드 이동만 Static하게 생성해두기 (feat. cond + event)</h2>
<h4>방법 2의 한계: 뒤로가기만 되고 앞으로가기는 안됨..</h4>
<p>앞으로가기를 구현하려고 봤더니 브라우저 히스토리가 그냥 stack + pop방식이 아니라는걸 인지했습니다.</p>
<p>예를 들어 a, b, c , 뒤로가기해서 b, 앞으로가기해서 a 했을 때</p>
<ul>
<li>stack이라면 히스토리가 [a, b, c, b, a]일테고</li>
<li>stack + pop이라면 히스토리가 [a]..일텐데 이건 말이 안됨. pop해버리면 앞으로가기 할수가 없더라구요.</li>
</ul>
<p>그래서 브라우저 히스토리는 stack + pop없이 index로 계산해야 합니다.
위 경우는 히스토리가 [a, b, c]이되 index가 a를 가리키고 있어야 하죠 (그래야 앞으로가기시 b, c를 기억해서 이동할 수 있으니)</p>
<p>그렇다고 앞으로가기를 위해 브라우저 히스토리와 동일하게 context에 stack + index를 구현해두는건 넘 빡세고 위험해보입니다. single source of truth가 아니니까요.</p>
<h4>다시 생각해보자</h4>
<p>바텀업 말고 탑다운으로 out of box에서 다시 생각해봅니다.
[a, b, c, b] 상황의 b페이지에서</p>
<ul>
<li>뒤로가기 하면 a</li>
<li>앞으로가기하면 b로 이동해야 합니다.</li>
</ul>
<p>문제는 <code class="language-text">Router.beforePopState</code> 는 뒤로가기와 앞으로가기를 구분할 수 없다는 거예요.
둘 모두에서 불립니다… history pop 이벤트핸들러의 리스너 함수니까요.</p>
<p>우리는 뒤로가기, 앞으로가기 구분 없이 다음 페이지를 알아내야 합니다.</p>
<p>그런데… 생각해보니 브라우저 히스토리 스택이 이미 내 다음 행선지를 다 알고 있네요?</p>
<p>xstate내부에 history context를 따로 관리하지 말고
브라우저 히스토리만 single source of truth로 관리하고
xstate에선 앞으로가기/뒤로가기시 가용한 모든 이벤트를 뚫어두고
얘가 다음 행선지를 안내하도록 해보면 어떨까요?</p>
<h4>히스토리 기반으로 from, to 알아내기</h4>
<p>일단 xstate를 떠나서 브라우저의 Router.beforePopState 이벤트로 뒤로가기, 앞으로가기시 현재페이지/이동할페이지 경로를 알아냅니다.</p>
<p>위에서 service.onTransition 으로 경로가 변할 때마다 router shallow push를 하고있었기 때문에 브라우저 히스토리 스택은 착실히 쌓이고 있었을 것예요.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">Router<span class="token punctuation">.</span><span class="token function">beforePopState</span><span class="token punctuation">(</span><span class="token parameter">prop</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">as</span> <span class="token punctuation">}</span> <span class="token operator">=</span> prop
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">to</span><span class="token operator">:</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span><span class="token keyword">as</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token literal-property property">from</span><span class="token operator">:</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span>Router<span class="token punctuation">.</span>asPath<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>굿. 뒤로가기, 앞으로가기 해보니 from, to 가 잘 찍히네요.</p>
<h4>xstate 이벤트에 행선지 보내기</h4>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">Router<span class="token punctuation">.</span><span class="token function">beforePopState</span><span class="token punctuation">(</span><span class="token parameter">prop</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">as</span> <span class="token punctuation">}</span> <span class="token operator">=</span> prop

  <span class="token keyword">const</span> nextPageName <span class="token operator">=</span> <span class="token constant">QS</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">as</span><span class="token punctuation">)</span><span class="token punctuation">[</span>stepQueryKey<span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">as</span> <span class="token operator">!==</span> Router<span class="token punctuation">.</span>asPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"NAVIGATE"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">navigateTarget</span><span class="token operator">:</span> nextPageName <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// xstate 머신</span>
machine <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token constant">PUSH_HISTORY</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">actions</span><span class="token operator">:</span> <span class="token string">"pushHistory"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token constant">NAVIGATE</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token comment">// B에서 A로 뒤로가기</span>
        <span class="token comment">// 현재페이지가 B고 히스토리 이벤트에서 넘겨준 타겟이 A라면 A로 이동해라</span>
        <span class="token function-variable function">cond</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">_context<span class="token punctuation">,</span> event<span class="token punctuation">,</span> meta</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> currentStateValueMatched <span class="token operator">=</span> meta<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">"B"</span>
          <span class="token keyword">const</span> navigateTargetMatched <span class="token operator">=</span> event<span class="token punctuation">.</span>navigateTarget <span class="token operator">===</span> <span class="token string">"A"</span>
          <span class="token keyword">return</span> <span class="token punctuation">(</span>
            currentStateValueMatched <span class="token operator">===</span> <span class="token boolean">true</span> <span class="token operator">&amp;&amp;</span> navigateTargetMatched <span class="token operator">===</span> <span class="token boolean">true</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">"A"</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token function-variable function">cond</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">_context<span class="token punctuation">,</span> event<span class="token punctuation">,</span> meta</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token comment">// A에서 B로 앞으로가기</span>
          <span class="token comment">// 현재페이지가 A고 히스토리 이벤트에서 넘겨준 타겟이 B라면 B로 이동해라</span>
          <span class="token keyword">const</span> currentStateValueMatched <span class="token operator">=</span> meta<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">"A"</span>
          <span class="token keyword">const</span> navigateTargetMatched <span class="token operator">=</span> event<span class="token punctuation">.</span>navigateTarget <span class="token operator">===</span> <span class="token string">"B"</span>
          <span class="token keyword">return</span> <span class="token punctuation">(</span>
            currentStateValueMatched <span class="token operator">===</span> <span class="token boolean">true</span> <span class="token operator">&amp;&amp;</span> navigateTargetMatched <span class="token operator">===</span> <span class="token boolean">true</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">"B"</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  states<span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<p>generate 함수를 만들기 전에, 잘 되는지 static하게 테스트를 해봅니다.
A ↔ B 사이를 앞으로 가기, 뒤로가기 할 수 있도록</p>
<p>A에서 B로 이동하는 이벤트, B에서 A로 가는 이벤트를 뚫어줍니다.</p>
<ul>
<li>컨디션: 현재 머신상태가 b + 푸시타겟이 a라면: 타겟은 a</li>
<li>컨디션: 현재 머신상태가 a + 푸시타겟이 b라면: 타겟은 b</li>
</ul>
<p>잘 동작한다! 감덩…</p>
<p>이로 인해 브라우저 history와 xstate context history 가 꼬일 걱정도 덜었습니다.</p>
<h4>인접한 노드 사이를 이동할 수 있는 이벤트 generate 함수</h4>
<p>방법2 에서 만들었던 함수를 조금만 고치면 됩니다.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">generateNavigateConditions</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">states</span><span class="token operator">:</span> StatesConfig<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token punctuation">,</span> any<span class="token operator">></span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token literal-property property">conditions</span><span class="token operator">:</span> TransitionsConfig<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>states<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">stateValue</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> stateNodeConfig <span class="token operator">=</span> states<span class="token punctuation">[</span>stateValue<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stateNodeConfig <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> targetStepNodes <span class="token operator">=</span> <span class="token function">deepSearchItems</span><span class="token punctuation">(</span>stateNodeConfig<span class="token punctuation">,</span> <span class="token string">"target"</span><span class="token punctuation">)</span>

    targetStepNodes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> target <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      conditions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
        <span class="token function">getCondition</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">before</span><span class="token operator">:</span> stateValue<span class="token punctuation">,</span> <span class="token literal-property property">after</span><span class="token operator">:</span> target <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">getCondition</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">before</span><span class="token operator">:</span> target<span class="token punctuation">,</span> <span class="token literal-property property">after</span><span class="token operator">:</span> stateValue <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> conditions
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">getCondition</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  before<span class="token punctuation">,</span>
  after<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">before</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token literal-property property">after</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">cond</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">_context</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">event</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">meta</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> currentStateValueMatched <span class="token operator">=</span> meta<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value <span class="token operator">===</span> before
    <span class="token keyword">const</span> navigateTargetMatched <span class="token operator">=</span> event<span class="token punctuation">.</span>navigateTarget <span class="token operator">===</span> after
    <span class="token keyword">return</span> currentStateValueMatched <span class="token operator">===</span> <span class="token boolean">true</span> <span class="token operator">&amp;&amp;</span> navigateTargetMatched <span class="token operator">===</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">target</span><span class="token operator">:</span> after<span class="token punctuation">,</span>
  <span class="token literal-property property">event</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token comment">// 필요 없지만 타입을 맞추기 위해 넣음</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// xstate 머신</span>
machine <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token constant">PUSH_HISTORY</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">actions</span><span class="token operator">:</span> <span class="token string">"pushHistory"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token constant">NAVIGATE</span><span class="token operator">:</span> <span class="token function">generateNavigateConditions</span><span class="token punctuation">(</span>states<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  states<span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<h4>요약</h4>
<p>XState 그래프를 받아 앞으로/뒤로 이동 가능한 모든 케이스의 컨디션을 생성합니다.
브라우저의 뒤로가기, 앞으로가기 이벤트에서 사용합니다.</p>
<p>[왜 필요한가요?]
XState는 정해진 개수의 이벤트를 통해 상태를 변경시키는 컨셉을 가지고 있습니다.
예를 들어 NEXT라는 이벤트를 통해 A페이지에서 B페이지로 상태를 이동했다면,
뒤로가기를 위해서 B페이지에서 A페이지로 상태를 이동하는 이벤트도 사전에 정의해줘야 합니다.</p>
<p>하지만 이를 위해 모든 노드에 뒤로가기 이벤트를 하드코딩으로 심는건 비효율적일 뿐더러
동적으로 이동한 경우나 앞으로가는 경우는 실제 브라우저의 history가 쌓이기 전까진 알 수 없습니다
(e.g. C에서 뒤로가기시 A에서 왔는지, B에서 왔는지 정적으로는 판별 불가능)</p>
<p>이를 해결하기 위해 XState의 그래프를 받아 이동 가능한 모든 케이스의 컨디션을 생성해두고,
브라우저의 뒤로가기, 앞으로가기 이벤트 발생시 이동해야 하는 페이지를 XState이벤트 인자에 넘겨
걸맞는 condition을 타서 원하는 target으로 상태를 변경시킵니다.</p>
<p>[Use case]</p>
<ol>
<li>브라우저의 popState이벤트 발생. 브라우저는 현재 페이지와 이동해야할 페이지를 알고 있다.</li>
<li>브라우저가 XState에 “나는 지금 B페이지야. A페이지로 이동해” 라고 요청한다.</li>
<li>XState는 해당 이벤트를 듣고, 현재 B페이지일때(state.value == ‘B’) 이벤트 인자가 A페이지라는(event. navigateTarget == ‘A’) 조건을 찾는다. 해당 조건은 target을 ‘A’로 변경해준다.</li>
<li>이로서 브라우저도, XState도 현재 상태가 A페이지가 된다.</li>
</ol>
<h2>나 말고 다른 사람들의 Needs…</h2>
<p>아무도 사용하지 않았던 방식. 라이브러리로 만들어서 제공해보자</p>
<ul>
<li><a href="https://github.com/statelyai/xstate/issues/188">https://github.com/statelyai/xstate/issues/188</a></li>
<li><a href="https://github.com/statelyai/xstate/discussions/1654">https://github.com/statelyai/xstate/discussions/1654</a></li>
</ul>
<!-- - 이렇게 하려면 step 이동시마다 history를 쌓아야 한다
  - 머신 밖에서 동적으로 쌓기
    - onTransition에서 `send('PUSH_HISTORY', {currentStep: state.value})` 하면 이 이벤트가 상태 전이를 일으키지 않더라도 다시 onTransition을 부르나봄... 그래서 무한호출
      - send 호출로 일어난 onTransition을 발라낼 수 있다면 거기선 send를 안 하면 될텐데
        - => 이렇게 해서 성공! 무한호출이 일어나서 보기 어렵다면 debugger를 걸자
  - 머신 내부에서 정적으로 정의해두기
    - 모든 transition이 일어날 때마다 추가적으로 호출되는 이펙트에 PUSH_HISTORY 액션을 태우자
    - 머신 최상단에 `always: { actions: 'pushHistory', cond: 'isAlways' },` 를 정의하고, isAlways 가드를 true로 반환하게 하니까 maximum call stack 에러가 난다. --></section><hr/><footer><div class="bio" style="align-items:center"><div data-gatsby-image-wrapper="" style="width:50px;height:50px" class="gatsby-image-wrapper bio-avatar"><div aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear;background-color:#080808;width:50px;height:50px;position:relative"></div><picture><source type="image/avif" data-srcset="/static/6f6993e6bccd3c63f94928a53c7d7f94/d4bf4/profile-pic.avif 50w,/static/6f6993e6bccd3c63f94928a53c7d7f94/ee81f/profile-pic.avif 100w" sizes="50px"/><source type="image/webp" data-srcset="/static/6f6993e6bccd3c63f94928a53c7d7f94/3faea/profile-pic.webp 50w,/static/6f6993e6bccd3c63f94928a53c7d7f94/6a679/profile-pic.webp 100w" sizes="50px"/><img data-gatsby-image-ssr="" layout="fixed" data-main-image="" style="opacity:0" sizes="50px" decoding="async" loading="lazy" data-src="/static/6f6993e6bccd3c63f94928a53c7d7f94/e5610/profile-pic.png" data-srcset="/static/6f6993e6bccd3c63f94928a53c7d7f94/e5610/profile-pic.png 50w,/static/6f6993e6bccd3c63f94928a53c7d7f94/e9b55/profile-pic.png 100w" alt="Profile picture"/></picture><noscript><picture><source type="image/avif" srcSet="/static/6f6993e6bccd3c63f94928a53c7d7f94/d4bf4/profile-pic.avif 50w,/static/6f6993e6bccd3c63f94928a53c7d7f94/ee81f/profile-pic.avif 100w" sizes="50px"/><source type="image/webp" srcSet="/static/6f6993e6bccd3c63f94928a53c7d7f94/3faea/profile-pic.webp 50w,/static/6f6993e6bccd3c63f94928a53c7d7f94/6a679/profile-pic.webp 100w" sizes="50px"/><img data-gatsby-image-ssr="" layout="fixed" data-main-image="" style="opacity:0" sizes="50px" decoding="async" loading="lazy" src="/static/6f6993e6bccd3c63f94928a53c7d7f94/e5610/profile-pic.png" srcSet="/static/6f6993e6bccd3c63f94928a53c7d7f94/e5610/profile-pic.png 50w,/static/6f6993e6bccd3c63f94928a53c7d7f94/e9b55/profile-pic.png 100w" alt="Profile picture"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1,e.parentNode.parentNode.querySelector("[data-placeholder-image]").style.opacity=0)}}</script></div><p><strong>진유림</strong> a.k.a <!-- -->테니스치다 손목 삔, 풋살하다 인대 나간 개발자<!-- --> <a href="https://twitter.com/jayjinjay">twitter</a></p></div></footer></article><div id="disqus_thread"></div><nav class="blog-post-nav"><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/dev/220913-xstate-docs/">← <!-- -->XState 공식문서 탐구</a></li><li><a rel="next" href="/dev/22092-xstate-funnel/">XState with Funnel<!-- --> →</a></li></ul></nav></main><footer>With love, Yurim Jin</footer></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4ZD0PJFMV4"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-4ZD0PJFMV4', {"send_page_view":false});
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/dev/220923-xstate-go-back/";window.___webpackCompilationHash="49ed4bbf430578b28a1a";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-30f2bf2a1846f97f91ab.js"],"app":["/app-54502c4e41ac892a6988.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-c2e532ae7a6f8a61753f.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-c98584dbeb0210b2c44c.js"],"component---src-pages-using-typescript-tsx":["/component---src-pages-using-typescript-tsx-16ee82ec4eb3346477f0.js"],"component---src-templates-blog-post-tsx":["/component---src-templates-blog-post-tsx-c313bc69d4d836a1a1da.js"],"component---src-templates-category-tsx":["/component---src-templates-category-tsx-c31f4739ffa790464fb1.js"]};/*]]>*/</script><script src="/polyfill-30f2bf2a1846f97f91ab.js" nomodule=""></script><script src="/app-54502c4e41ac892a6988.js" async=""></script><script src="/framework-b9a5f57e28a68b87a1d1.js" async=""></script><script src="/webpack-runtime-ac00cd1768bca3d6c522.js" async=""></script></body></html>